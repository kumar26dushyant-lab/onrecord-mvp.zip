<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONRECORD ‚Äî When messages need to be taken seriously</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #000;
            --text: #fff;
            --text-dim: #888;
            --accent: #ff2d2d;
            --border: #1a1a1a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 60px 24px;
        }

        .hero h1 {
            font-size: clamp(3rem, 12vw, 9rem);
            font-weight: 700;
        }

        .hero h1 span { color: var(--accent); }

        .subline {
            color: var(--text-dim);
            margin-top: 12px;
        }

        .cta-button {
            margin-top: 40px;
            padding: 18px 42px;
            font-weight: 600;
            background: white;
            color: black;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .generator {
            padding: 100px 24px;
            border-top: 1px solid var(--border);
        }

        .generator-container {
            max-width: 600px;
            margin: auto;
        }

        textarea, select {
            width: 100%;
            padding: 16px;
            margin-top: 16px;
            background: #0a0a0a;
            color: white;
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        button.generate-btn {
            margin-top: 20px;
            width: 100%;
            padding: 18px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .result { margin-top: 40px; display: none; }
        .result.show { display: block; }

        video {
            width: 100%;
            border-radius: 10px;
        }

        .error-message { color: #ff2d2d; margin-top: 12px; }
        .status-message { color: #00ff88; margin-top: 12px; }
    </style>
</head>

<body>

<section class="hero">
    <h1>Put it <span>ONRECORD.</span></h1>
    <p class="subline">When messages need to be taken seriously.</p>
    <button class="cta-button"
        onclick="document.getElementById('generator').scrollIntoView({behavior:'smooth'})">
        Create ONRECORD Video
    </button>
</section>

<section class="generator" id="generator">
    <div class="generator-container">

        <form id="generatorForm">
            <textarea id="messageText" maxlength="500" required
                placeholder="Type your message..."></textarea>

            <select id="tonePicker">
                <option value="serious">Serious AF</option>
                <option value="calm">Calm but Deadly</option>
                <option value="fake">Fake Serious üòè</option>
            </select>

            <button class="generate-btn" id="generateBtn">
                Generate ONRECORD
            </button>
        </form>

        <div class="status-message" id="statusMessage"></div>
        <div class="error-message" id="errorMessage"></div>

        <div class="result" id="result">
            <video id="resultVideo" controls></video>
            <a id="downloadBtn" download="onrecord.mp4">Download Video</a>
        </div>

    </div>
</section>

<script>
/* =====================================================
   ‚úÖ SAME-ORIGIN API (NO CORS / NO PROXY)
===================================================== */

const form = document.getElementById('generatorForm');
const btn = document.getElementById('generateBtn');
const msg = document.getElementById('messageText');
const tone = document.getElementById('tonePicker');
const result = document.getElementById('result');
const video = document.getElementById('resultVideo');
const download = document.getElementById('downloadBtn');
const statusMsg = document.getElementById('statusMessage');
const errorMsg = document.getElementById('errorMessage');

form.addEventListener('submit', async (e) => {
    e.preventDefault();

    errorMsg.textContent = '';
    statusMsg.textContent = 'Generating video...';
    btn.disabled = true;

    try {
        const res = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: msg.value.trim(),
                tone: tone.value,
                paid: false
            })
        });

        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server did not return JSON');
        }

        const data = await res.json();

        if (!res.ok) {
            throw new Error(data.error || 'Generation failed');
        }

        let videoUrl = null;

        if (data.videoUrl) {
            videoUrl = data.videoUrl;
        } else if (data.jobId) {
            videoUrl = await pollStatus(data.jobId);
        } else {
            throw new Error('Server returned neither jobId nor videoUrl');
        }

        video.src = videoUrl;
        download.href = videoUrl;
        result.classList.add('show');
        statusMsg.textContent = '';

    } catch (err) {
        console.error(err);
        errorMsg.textContent = err.message;
        statusMsg.textContent = '';
    } finally {
        btn.disabled = false;
    }
});

async function pollStatus(jobId) {
    if (!jobId) {
        throw new Error('Invalid jobId');
    }

    for (let i = 0; i < 60; i++) {
        const r = await fetch(`/api/status/${jobId}`);
        const contentType = r.headers.get('content-type');

        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Status endpoint did not return JSON');
        }

        const d = await r.json();

        if (d.status === 'completed') return d.videoUrl;
        if (d.status === 'failed') throw new Error('Video generation failed');

        await new Promise(res => setTimeout(res, 2000));
    }

    throw new Error('Video generation timed out');
}
</script>

</body>
</html>
