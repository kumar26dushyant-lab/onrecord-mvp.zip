<script>
    // DOM Elements
    const form = document.getElementById('generatorForm');
    const generateBtn = document.getElementById('generateBtn');
    const messageText = document.getElementById('messageText');
    const tonePicker = document.getElementById('tonePicker');
    const result = document.getElementById('result');
    const resultVideo = document.getElementById('resultVideo');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusMessage = document.getElementById('statusMessage');
    const errorMessage = document.getElementById('errorMessage');

    // Form submission
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const text = messageText.value.trim();
        const tone = tonePicker.value;

        if (!text) {
            showError('Please enter a message');
            return;
        }

        generateBtn.classList.add('loading');
        generateBtn.disabled = true;
        hideError();
        hideStatus();
        result.classList.remove('show');

        showStatus('Starting video generation...');

        try {
            // ✅ SAME-ORIGIN API CALL (NO CORS)
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: text,
                    tone: tone,
                    paid: false
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to generate video');
            }

            if (data.jobId) {
                showStatus('Processing your video... This may take 30-60 seconds.');
                const videoUrl = await pollForCompletion(data.jobId);
                showResult(videoUrl);
            } else if (data.videoUrl) {
                showResult(data.videoUrl);
            } else {
                throw new Error('No video URL received');
            }

        } catch (error) {
            console.error('Generation error:', error);
            showError(error.message || 'Something went wrong. Please try again.');
        } finally {
            generateBtn.classList.remove('loading');
            generateBtn.disabled = false;
            hideStatus();
        }
    });

    // Poll for video completion
    async function pollForCompletion(jobId) {
        const maxAttempts = 60;
        let attempts = 0;

        while (attempts < maxAttempts) {
            attempts++;

            // ✅ SAME-ORIGIN STATUS CHECK
            const response = await fetch(`/api/status/${jobId}`);
            const data = await response.json();

            if (data.status === 'completed' && data.videoUrl) {
                return data.videoUrl;
            } else if (data.status === 'failed') {
                throw new Error(data.error || 'Video generation failed');
            }

            await new Promise(resolve => setTimeout(resolve, 2000));
            showStatus(`Processing your video... (${attempts * 2}s)`);
        }

        throw new Error('Video generation timed out. Please try again.');
    }

    function showResult(videoUrl) {
        resultVideo.src = videoUrl;
        downloadBtn.href = videoUrl;
        result.classList.add('show');
        result.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function resetGenerator() {
        messageText.value = '';
        result.classList.remove('show');
        resultVideo.src = '';
        hideError();
        hideStatus();
        messageText.focus();
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add('show');
    }

    function hideError() {
        errorMessage.classList.remove('show');
    }

    function showStatus(message) {
        statusMessage.textContent = message;
        statusMessage.classList.add('show');
    }

    function hideStatus() {
        statusMessage.classList.remove('show');
    }

    // Modal logic (unchanged)
    const watchLink = document.getElementById('watchLink');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalClose = document.getElementById('modalClose');
    const demoVideo = document.getElementById('demoVideo');

    watchLink.addEventListener('click', function() {
        modalOverlay.classList.add('active');
        document.body.classList.add('modal-open');
        demoVideo.play();
    });

    function closeModal() {
        modalOverlay.classList.remove('active');
        document.body.classList.remove('modal-open');
        demoVideo.pause();
        demoVideo.currentTime = 0;
    }

    modalClose.addEventListener('click', closeModal);

    modalOverlay.addEventListener('click', function(e) {
        if (e.target === modalOverlay) {
            closeModal();
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
            closeModal();
        }
    });
</script>
